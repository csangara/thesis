# 'results/cell_type_weights_doublets.pdf')
plot_weights_doublet(cell_type_names, spatialRNA, resultsdir, results$weights_doublet,
results$results_df)
# Plots the number of confident pixels of each cell type in 'full_mode'. (saved as
# 'results/cell_type_occur.pdf')
plot_cond_occur(cell_type_names, resultsdir, norm_weights, spatialRNA)
# makes a map of all cell types, (saved as
# 'results/all_cell_types.pdf')
plot_all_cell_types(results$results_df, spatialRNA@coords, cell_type_names, resultsdir)
# doublets
#obtain a dataframe of only doublets
doublets <- results$results_df[results$results_df$spot_class == "doublet_certain",]
# Plots all doublets in space (saved as
# 'results/all_doublets.pdf')
plot_doublets(spatialRNA, doublets, resultsdir, cell_type_names)
# Plots all doublets in space for each cell type (saved as
# 'results/all_doublets_type.pdf')
plot_doublets_type(spatialRNA, doublets, resultsdir, cell_type_names)
# a table of frequency of doublet pairs
doub_occur <- table(doublets$second_type, doublets$first_type)
# Plots a stacked bar plot of doublet ocurrences (saved as
# 'results/doublet_stacked_bar.pdf')
plot_doub_occur_stack(doub_occur, resultsdir, cell_type_names)
# get a SpatialRNA object that has single cell types, each with a spatial coordinate and RNA
# counts.
puck_d <- get_decomposed_data(results$results_df, myRCTD@internal_vars$gene_list_reg, spatialRNA, results$weights_doublet,
myRCTD@cell_type_info$renorm)
library(Seurat)
?dimensional_reduction
Seurat::JackStraw()
?Seurat::JackStraw
#' @references Inspired by Chung et al, Bioinformatics (2014)
#'
#' @export
#'
#' @examples
#' \dontrun{
#' pbmc_small = suppressWarnings(JackStraw(pbmc_small))
#' head(JS(object = pbmc_small[['pca']], slot = 'empirical'))
#' }
#'
createSynthvisiumRDS <- function(inputscRNA_rds, dataset_type, output_folder="synthvisium_spatial/"){
seurat_obj_scRNA =  readRDS(inputscRNA_rds)
# Create synthetic visium data from scRNA data, then preprocess
synthetic_visium_data = generate_synthetic_visium(seurat_obj = seurat_obj_scRNA, dataset_type = dataset_type,
clust_var = "subclass", region_var = "brain_subregion" , n_regions = NULL,
n_spots_min = 50, n_spots_max = 200, visium_mean = 20000, visium_sd = 5000)
directory = dirname(inputscRNA_rds)
inputscRNA_name = str_split(basename(inputscRNA_rds), "\\.")[[1]][1]
saveRDS(synthetic_visium_data, paste0(directory, "/", output_folder, inputscRNA_name, "_", dataset_type, "_synthvisium.rds"))
print(paste0("Dataset saved at ", directory, "/", output_folder, inputscRNA_name, "_", dataset_type, "_synthvisium.rds"))
}
?createSynthvisiumRDS
??createSynthvisiumRDS
library(Seurat)
library(synthvisium)
library(dplyr)
library(SPOTlight)
source("helperFunctions.R")
possible_dataset_types = c("real", "real_top1","real_top1_uniform","real_top2_overlap","real_top2_overlap_uniform",
"real_missing_celltypes_visium", "artificial_uniform_distinct", "artificial_diverse_distinct",
"artificial_uniform_overlap", "artificial_diverse_overlap", "artificial_dominant_celltype_diverse",
"artificial_partially_dominant_celltype_diverse", "artificial_missing_celltypes_visium")
setwd("D:/Work (Yr 2 Sem 1)/Thesis/Scripts")
path <- "D:/Work (Yr 2 Sem 1)/Thesis/"
source("helperFunctions.R")
dataset_type = possible_dataset_types[1]
synthetic_visium_data <- readRDS(paste0(path, "rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_synthvisium.rds"))
seurat_obj_visium <- createAndPPSeuratFromVisium(synthetic_visium_data$counts)
Ident(seurat_obj_visium)
library(Seurat)
library(synthvisium)
library(dplyr)
library(SPOTlight)
Idents(seurat_obj_visium)
# Extract the top marker genes from each cluster
Idents(object = seurat_obj_scRNA) <- seurat_obj_scRNA@meta.data$subclass
# Load synthetic visium data and reference scRNA-seq data
seurat_obj_scRNA = readRDS(paste0(path, "rds/allen_cortex_dwn.rds"))
Idents(object = seurat_obj_scRNA)
Idents(object = seurat_obj_scRNA)  <- seurat_obj_scRNA@meta.data$subclass
Idents(object = seurat_obj_scRNA)
saveRDS(seurat_obj_scRNA, paste0(path,"rds/allen_cortex_dwn.rds"))
seurat_obj_scRNA@meta.data$celltype = seurat_obj_scRNA@meta.data$subclass
seurat_obj_scRNA = seurat_obj_scRNA %>% SetIdent(value = "celltype")
Idents(object = seurat_obj_scRNA)
saveRDS(seurat_obj_scRNA, paste0(path,"rds/allen_cortex_dwn.rds"))
seurat_obj_scRNA@meta.data$celltype
seurat_obj_visium@meta.data$celltype
# Create ExpressionSet object from seurat object, assuming the Ident of the object is the cell type
SeuratToExprSet <- function(seurat_object){
sc.pheno <- data.frame(check.names=F, check.rows=F,
stringsAsFactors=F,
row.names=names(Idents(seurat_object)),
samples=names(Idents(seurat_object)))
if (!is.null(seurat_object@metadata$celltype)){
sc.pheno$celltype = seurat_object@meta.data$celltype
}
sc.pdata <- new("AnnotatedDataFrame",
data=sc.pheno)
sc.data <- as.matrix(GetAssayData(seurat_object)[,names(Idents(seurat_object)),drop=F])
sc.eset <- ExpressionSet(assayData=sc.data, phenoData=sc.pdata)
return(sc.eset)
}
# Convert seurat objects to expression set
eset_obj_visium <- SeuratToExprSet(seurat_obj_visium)
# Create ExpressionSet object from seurat object, assuming the Ident of the object is the cell type
SeuratToExprSet <- function(seurat_object){
sc.pheno <- data.frame(check.names=F, check.rows=F,
stringsAsFactors=F,
row.names=names(Idents(seurat_object)),
samples=names(Idents(seurat_object)))
if (!is.null(seurat_object@meta.data$celltype)){
sc.pheno$celltype = seurat_object@meta.data$celltype
}
sc.pdata <- new("AnnotatedDataFrame",
data=sc.pheno)
sc.data <- as.matrix(GetAssayData(seurat_object)[,names(Idents(seurat_object)),drop=F])
sc.eset <- ExpressionSet(assayData=sc.data, phenoData=sc.pdata)
return(sc.eset)
}
# Convert seurat objects to expression set
eset_obj_visium <- SeuratToExprSet(seurat_obj_visium)
library(Biobase)
# Convert seurat objects to expression set
eset_obj_visium <- SeuratToExprSet(seurat_obj_visium)
eset_obj_scRNA <- SeuratToExprSet(seurat_obj_scRNA)
deconv_music = music_prop(bulk.eset = eset_obj_visium, sc.eset = eset_obj_scRNA, clusters = 'celltype', samples='samples')
library(MuSiC)
deconv_music = music_prop(bulk.eset = eset_obj_visium, sc.eset = eset_obj_scRNA, clusters = 'celltype', samples='samples')
??pVar
library(xbioc)
deconv_music = music_prop(bulk.eset = eset_obj_visium, sc.eset = eset_obj_scRNA, clusters = 'celltype', samples='samples')
res = cor(t(mixture$relative_spot_composition[,1:23]), t(deconv_music$Est.prop.weighted[,1:23]))
res = cor(t(synthetic_visium_data$relative_spot_composition[,1:23]), t(deconv_music$Est.prop.weighted[,1:23]))
mean(diag(res), na.rm=TRUE)
saveRDS(music_deconv, paste0("rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_music.rds"))
music_deconv = deconv_music
saveRDS(music_deconv, paste0("rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_music.rds"))
saveRDS(music_deconv, paste0(path, "rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_music.rds"))
res = vector()
res[1] = 1
res[2] = 2
res = list()
res["hello"] = 1
res
res = list()
for (dataset_type in possible_dataset_types){
# Load synthetic visium data and convert to Expreset
synthetic_visium_data <- readRDS(paste0(path, "rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_synthvisium.rds"))
seurat_obj_visium <- createAndPPSeuratFromVisium(synthetic_visium_data$counts)
eset_obj_visium <- SeuratToExprSet(seurat_obj_visium)
# Deconvolution
music_deconv = music_prop(bulk.eset = eset_obj_visium, sc.eset = eset_obj_scRNA, clusters = 'celltype', samples='samples')
res[dataset_type] = cor(t(synthetic_visium_data$relative_spot_composition[,1:23]), t(music_deconv$Est.prop.weighted[,1:23]))
saveRDS(music_deconv, paste0(path, "rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_music.rds"))
}
View(res)
DimPlot(seurat_obj_scRNA, group.by = "subclass", label = T)
DimPlot(seurat_obj_scRNA, reduction = "umap",pt.size = 0.5, label = T)
# Visualize a priori defined regions vs clusters from gene expression
p_priorregion = DimPlot(seurat_obj_visium, reduction = "umap", label = TRUE, group.by = "orig.ident") # a priori defined regions
p_exprs_clusters = DimPlot(seurat_obj_visium, reduction = "umap", label = TRUE) #
patchwork::wrap_plots(list(p_priorregion, p_exprs_clusters), nrow = 1)
seurat_obj_visium
seurat_obj_visium@meta.data
?DimPlot
?FeaturePlot
seurat_obj_visium$orig.ident
seurat_obj_visium$nFeature_Spatial
seurat_obj_visium$seurat_clusters
synthetic_visium_data
seurat_obj_visium
seurat_obj_visium@meta.data
?DimPlot
seurat_obj_visium@meta.data
synthetic_visium_data$relative_spot_composition
rownames(seurat_obj_visium)
colnames(seurat_obj_visium)
names(synthetic_visium_data)
rownames(synthetic_visium_data)
colnames(synthetic_visium_data)
colnames(synthetic_visium_data$counts)
all(colnames(seurat_obj_visium) ==  colnames(synthetic_visium_data$counts))
all(colnames(seurat_obj_visium) ==  colnames(synthetic_visium_data$relative_spot_composition$name))
seurat_obj_visium@meta.data["names"] =  colnames(synthetic_visium_data$counts)
seurat_obj_visium@meta.data$names
seurat_obj_visium@meta.data$names = NULL
seurat_obj_visium@meta.data$names
synthetic_visium_data$relative_spot_composition
colnames(synthetic_visium_data$relative_spot_composition)
colnames(synthetic_visium_data$relative_spot_composition[1:23])
synthetic_visium_data$dataset_properties
colnames(synthetic_visium_data$relative_spot_composition)[1:23]
celltypes <- colnames(synthetic_visium_data$relative_spot_composition)[1:23]
all(colnames(seurat_obj_visium) ==  colnames(synthetic_visium_data$counts))
synthetic_visium_data$relative_spot_composition[celltypes[1]]
synthetic_visium_data$relative_spot_composition[celltypes[1],]
synthetic_visium_data$relative_spot_composition[,celltypes[1]]
synthetic_visium_data$relative_spot_composition[,celltypes[2]]
synthetic_visium_data$relative_spot_composition
for (celltype in celltypes){
seurat_obj_visium@meta.data[celltype] = synthetic_visium_data$relative_spot_composition[,celltype]
}
DimPlot(seurat_obj_visium, group.by = "brain_subregion")
DimPlot(seurat_obj_visium)
FeaturePlot(seurat_obj_visium, "Astro")
FeaturePlot(seurat_obj_visium, "CR")
dim(synthetic_visium_data$counts)
spotlight_deconv <- readRDS(paste0(path, "rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_spotlight.rds")
)
spotlight_deconv[[2]]
spotlight_deconv[[2]]["Astro"]
spotlight_deconv[[2]]["Astro",]
spotlight_deconv[[2]][,"Astro"]
for (celltype in celltypes){
seurat_obj_visium@meta.data[celltype] = synthetic_visium_data$relative_spot_composition[,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_pred")] = spotlight_deconv[[2]][,celltype]
}
for (celltype in celltypes){
print(celltype)
seurat_obj_visium@meta.data[celltype] = synthetic_visium_data$relative_spot_composition[,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_pred")] = spotlight_deconv[[2]][,celltype]
}
colnames(spotlight_deconv[[2]])
celltypes
colnames(spotlight_deconv[[2]])[1:23] = celltypes
for (celltype in celltypes){
seurat_obj_visium@meta.data[celltype] = synthetic_visium_data$relative_spot_composition[,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_pred")] = spotlight_deconv[[2]][,celltype]
}
FeaturePlot(seurat_obj_visium, "CR_pred")
par(mfrow=c(2,1))
FeaturePlot(seurat_obj_visium, "CR")
FeaturePlot(seurat_obj_visium, "CR_pred")
FeaturePlot(seurat_obj_visium, c("CR", "CR_pred"))
?FeaturePlot
png(paste0("plots/test.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c("CR", "CR_pred"))
dev.off()
dev.off()
png("plots/test.png", width=1000, height=350)
png(paste0(path, "plots/test.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c("CR", "CR_pred"))
dev.off()
for (celltype in celltypes){
seurat_obj_visium@meta.data[celltype] = synthetic_visium_data$relative_spot_composition[,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_spotlight")] = spotlight_deconv[[2]][,celltype]
png(paste0(path, "plots/", celltype, "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight")))
dev.off()
}
paste0(path, "plots/", celltype, "_spotlight.png")
str_replace(celltype, "/", ".")
for (celltype in celltypes){
seurat_obj_visium@meta.data[celltype] = synthetic_visium_data$relative_spot_composition[,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_spotlight")] = spotlight_deconv[[2]][,celltype]
png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight")))
dev.off()
}
png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight")))
dev.off()
dev.off()
for (celltype in celltypes){
png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight")))
dev.off()
}
celltype="Astro"
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight")))
png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight")))
dev.off()
for (celltype in celltypes){
png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
print(FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight"))))
dev.off()
}
deconv_music$Est.prop.weighted
rowSums(deconv_music$Est.prop.weighted)
deconv_music$Est.prop.weighted[,celltype]
length(deconv_music$Est.prop.weighted[,celltype])
nrow(deconv_music$Est.prop.weighted[,celltype])
nrow(deconv_music$Est.prop.weighted)
nrow(seurat_obj_visium@meta.data)
rm(deconv_music)
nrow(music_deconv$Est.prop.weighted)
music_deconv$Est.prop.weighted[,celltype]
for (celltype in celltypes){
seurat_obj_visium@meta.data[celltype] = synthetic_visium_data$relative_spot_composition[,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_spotlight")] = spotlight_deconv[[2]][,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_music")] = music_deconv$Est.prop.weighted[,celltype]
}
for (celltype in celltypes){
print(celltype)
seurat_obj_visium@meta.data[celltype] = synthetic_visium_data$relative_spot_composition[,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_spotlight")] = spotlight_deconv[[2]][,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_music")] = music_deconv$Est.prop.weighted[,celltype]
}
colnames(music_deconv$Est.prop.weighted)[1:23] = celltypes
for (celltype in celltypes){
print(celltype)
seurat_obj_visium@meta.data[celltype] = synthetic_visium_data$relative_spot_composition[,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_spotlight")] = spotlight_deconv[[2]][,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_music")] = music_deconv$Est.prop.weighted[,celltype]
}
for (celltype in celltypes){
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
print(FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music"))))
#dev.off()
}
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
print(FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music"), paste0(celltype, "_spotlight"))))
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
print(FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music"))))
text(50, 50, "test")
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
testplot = FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music"))))
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
testplot = FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music")))
text(50, 50, "test")
?FeaturePlot
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music"))) + geom_text()
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music"))) + geom_text(aes(50, 50, "test"))
?labs
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music"))) + labs("text")
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music"))) + labs(subtitle="text")
#
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music"))) + labs(subtitle="text")
paste0(112312)
dataset_type = possible_dataset_types[1]
# Load reference data and deconvolution results
synthetic_visium_data <- readRDS(paste0(path, "rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_synthvisium.rds"))
seurat_obj_visium <- createAndPPSeuratFromVisium(synthetic_visium_data$counts)
known_props <- synthetic_visium_data$relative_spot_composition[,1:23]
spotlight_deconv <- readRDS(paste0("rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_spotlight.rds"))
music_deconv <- readRDS(paste0("rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_music.rds"))
# Correlation
spotlight_corr <- cor(t(known_props), t(spotlight_deconv[[2]][,1:23]))
music_corr <- cor(t(known_props), t(music_deconv$Est.prop.weighted[,1:23]))
celltypes <- colnames(synthetic_visium_data$relative_spot_composition)[1:23]
colnames(spotlight_deconv[[2]])[1:23] = celltypes
colnames(music_deconv$Est.prop.weighted)[1:23] = celltypes
# Add deconv result to visium metadata
seurat_obj_visium@meta.data[celltype] = synthetic_visium_data$relative_spot_composition[,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_spotlight")] = spotlight_deconv[[2]][,celltype]
spotlight_deconv <- readRDS(paste0("rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_spotlight.rds"))
spotlight_deconv <- readRDS(paste0(path, "rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_spotlight.rds"))
music_deconv <- readRDS(paste0(path, "rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_music.rds"))
# Correlation
spotlight_corr <- cor(t(known_props), t(spotlight_deconv[[2]][,1:23]))
music_corr <- cor(t(known_props), t(music_deconv$Est.prop.weighted[,1:23]))
spotlight_corr
dim(music_corr)
music_corr_celltypes <- cor(known_props[,1:23], music_deconv$Est.prop.weighted[,1:23], use="complete.obs")
spotlight_corr_celltypes <- cor(known_props[,1:23], spotlight_deconv[[2]][,1:23], use="complete.obs")
View(music_corr_celltypes)
celltypes <- colnames(synthetic_visium_data$relative_spot_composition)[1:23]
colnames(spotlight_deconv[[2]])[1:23] = celltypes
colnames(music_deconv$Est.prop.weighted)[1:23] = celltypes
# Correlation
spotlight_corr_spots <- cor(t(known_props), t(spotlight_deconv[[2]][,1:23]))
spotlight_corr_celltypes <- cor(known_props[,1:23], spotlight_deconv[[2]][,1:23], use="complete.obs")
music_corr_spots <- cor(t(known_props), t(music_deconv$Est.prop.weighted[,1:23]))
music_corr_celltypes <- cor(known_props[,1:23], music_deconv$Est.prop.weighted[,1:23], use="complete.obs")
View(music_corr_spots)
View(music_corr_celltypes)
music_corr_celltypes["CR", "CR"]
#
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music"))) + labs(subtitle=paste0("Corr=",music_corr[celltype, celltype]))
# Add deconv result to visium metadata
seurat_obj_visium@meta.data[celltype] = synthetic_visium_data$relative_spot_composition[,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_spotlight")] = spotlight_deconv[[2]][,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_music")] = music_deconv$Est.prop.weighted[,celltype]
#
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music"))) + labs(subtitle=paste0("Corr=",music_corr[celltype, celltype]))
celltype
#
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music"))) + labs(subtitle=paste0("Corr=",music_corr_celltypes[celltype, celltype]))
#
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight"))) + labs(subtitle=paste0("Corr=",spotlight_corr_celltypes[celltype, celltype]))
?labs
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music"))) + labs(subtitle=c("hi", paste0("Corr=",music_corr_celltypes[celltype, celltype])))
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music")), patchwork=FALSE)
FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music")), combine=FALSE)
library(patchwork)
p1, p2 <- FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music")), combine=FALSE)
patchwork + FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music")), combine=FALSE)
patchwork <- FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_music")), combine=FALSE)
patchwork + plotAnnotation("test")
patchwork + plot_annotation(subtitle="test")
#
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
plots <- FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight"), paste0(celltype, "_music")), combine=FALSE)
plots
plots <- plots (p1) / (p2+p3)
plots <- plots[[1]] / (plots[[2]]+plots[[3]])
plots
plots[[2]] <- plots[[2]] + ggtitle("spotlight", paste0("Corr=",spotlight_corr_celltypes[celltype, celltype]))
plots <- plots[[1]] / (plots[[2]]+plots[[3]])
plots[[2]]
#
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
plots <- FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight"), paste0(celltype, "_music")), combine=FALSE)
plots[[2]] <- plots[[2]] + ggtitle("spotlight", paste0("Corr=",spotlight_corr_celltypes[celltype, celltype]))
plots <- plots[[1]] / (plots[[2]]+plots[[3]])
patchwork + plot_annotation(subtitle="test")
patchwork
plots
round(music_corr_celltypes[celltype, celltype], 2)
round(music_corr_celltypes[celltype, celltype], 3)
#
#png(paste0(path, "plots/", str_replace(celltype, "/", "."), "_spotlight.png"), width=1000, height=350)
plots <- FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight"), paste0(celltype, "_music")), combine=FALSE)
plots[[2]] <- plots[[2]] + ggtitle("SPOTlight", paste0("Corr=",
round(spotlight_corr_celltypes[celltype, celltype], 3)))
plots[[3]] <- plots[[3]] + ggtitle("MuSiC", paste0("Corr=",
round(music_corr_celltypes[celltype, celltype], 3)))
plots <- plots[[1]] / (plots[[2]]+plots[[3]])
plots
plot_dir <- paste0(path, "plots/allen_cortex_dwn/", dataset_type, "/")
mkdir(plot_dir)
plot_dir <- paste0(path, "plots/allen_cortex_dwn/", dataset_type, "/")
if (!dir.exists(plot_dir)){ dir.create(plot_dir) }
plots <- FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight"), paste0(celltype, "_music")), combine=FALSE)
plots[[2]] <- plots[[2]] + ggtitle("SPOTlight", paste0("Corr=",
round(spotlight_corr_celltypes[celltype, celltype], 3)))
plots[[3]] <- plots[[3]] + ggtitle("MuSiC", paste0("Corr=",
round(music_corr_celltypes[celltype, celltype], 3)))
plots <- plots[[1]] / (plots[[2]]+plots[[3]])
png(paste0(plot_dir, str_replace(celltype, "/", "."), ".png"), width=1000, height=500)
print(plots)
dev.off()
plots <- plots[[1]]+plot_spacer() / (plots[[2]]+plots[[3]])
plots <- FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight"), paste0(celltype, "_music")), combine=FALSE)
plots[[2]] <- plots[[2]] + ggtitle("SPOTlight", paste0("Corr=",
round(spotlight_corr_celltypes[celltype, celltype], 3)))
plots[[3]] <- plots[[3]] + ggtitle("MuSiC", paste0("Corr=",
round(music_corr_celltypes[celltype, celltype], 3)))
plots <- plots[[1]]+plot_spacer() / (plots[[2]]+plots[[3]])
png(paste0(plot_dir, str_replace(celltype, "/", "."), ".png"), width=1000, height=500)
print(plots)
dev.off()
plots <- plots[[1]] + plot_spacer() + plots[[2]]+plots[[3]]
plots <- FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight"), paste0(celltype, "_music")), combine=FALSE)
plots[[2]] <- plots[[2]] + ggtitle("SPOTlight", paste0("Corr=",
round(spotlight_corr_celltypes[celltype, celltype], 3)))
plots[[3]] <- plots[[3]] + ggtitle("MuSiC", paste0("Corr=",
round(music_corr_celltypes[celltype, celltype], 3)))
plots <- plots[[1]] + plot_spacer() + plots[[2]]+plots[[3]]
print(plots)
for (celltype in celltypes){
# Add deconv result to visium metadata
seurat_obj_visium@meta.data[celltype] = synthetic_visium_data$relative_spot_composition[,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_spotlight")] = spotlight_deconv[[2]][,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_music")] = music_deconv$Est.prop.weighted[,celltype]
plot_dir <- paste0(path, "plots/allen_cortex_dwn/", dataset_type, "/")
if (!dir.exists(plot_dir)){ dir.create(plot_dir) }
plots <- FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight"), paste0(celltype, "_music")), combine=FALSE)
plots[[2]] <- plots[[2]] + ggtitle("SPOTlight", paste0("Corr=",
round(spotlight_corr_celltypes[celltype, celltype], 3)))
plots[[3]] <- plots[[3]] + ggtitle("MuSiC", paste0("Corr=",
round(music_corr_celltypes[celltype, celltype], 3)))
plots <- plots[[1]] + plot_spacer() + plots[[2]]+plots[[3]]
png(paste0(plot_dir, str_replace(celltype, "/", "."), ".png"), width=1000, height=500)
print(plots)
dev.off()
}
for (dataset_type in possible_dataset_types){
# Load reference data and deconvolution results
synthetic_visium_data <- readRDS(paste0(path, "rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_synthvisium.rds"))
seurat_obj_visium <- createAndPPSeuratFromVisium(synthetic_visium_data$counts)
known_props <- synthetic_visium_data$relative_spot_composition[,1:23]
spotlight_deconv <- readRDS(paste0(path, "rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_spotlight.rds"))
music_deconv <- readRDS(paste0(path, "rds/synthvisium_spatial/allen_cortex_dwn_", dataset_type, "_music.rds"))
celltypes <- colnames(synthetic_visium_data$relative_spot_composition)[1:23]
colnames(spotlight_deconv[[2]])[1:23] = celltypes
colnames(music_deconv$Est.prop.weighted)[1:23] = celltypes
# Correlation (by spots and by cell type)
spotlight_corr_spots <- cor(t(known_props), t(spotlight_deconv[[2]][,1:23]))
spotlight_corr_celltypes <- cor(known_props[,1:23], spotlight_deconv[[2]][,1:23], use="complete.obs")
music_corr_spots <- cor(t(known_props), t(music_deconv$Est.prop.weighted[,1:23]))
music_corr_celltypes <- cor(known_props[,1:23], music_deconv$Est.prop.weighted[,1:23], use="complete.obs")
for (celltype in celltypes){
# Add deconv result to visium metadata
seurat_obj_visium@meta.data[celltype] = synthetic_visium_data$relative_spot_composition[,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_spotlight")] = spotlight_deconv[[2]][,celltype]
seurat_obj_visium@meta.data[paste0(celltype, "_music")] = music_deconv$Est.prop.weighted[,celltype]
plot_dir <- paste0(path, "plots/allen_cortex_dwn/", dataset_type, "/")
if (!dir.exists(plot_dir)){ dir.create(plot_dir) }
plots <- FeaturePlot(seurat_obj_visium, c(celltype, paste0(celltype, "_spotlight"), paste0(celltype, "_music")), combine=FALSE)
plots[[2]] <- plots[[2]] + ggtitle("SPOTlight", paste0("Corr=",
round(spotlight_corr_celltypes[celltype, celltype], 3)))
plots[[3]] <- plots[[3]] + ggtitle("MuSiC", paste0("Corr=",
round(music_corr_celltypes[celltype, celltype], 3)))
plots <- plots[[1]] + plot_spacer() + plots[[2]]+plots[[3]]
png(paste0(plot_dir, str_replace(celltype, "/", "."), ".png"), width=1000, height=500)
print(plots)
dev.off()
}
}
